<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time lanes</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <nav id="navbar">
        <ul class="main-menu-list">
            <li class="main-menu-item">
                <svg width="90%" viewBox="0 0 978 384" xmlns="http://www.w3.org/2000/svg">
                    <path id="res-icon" class="icon"
                        d="m51 32.09c-18.28 3.88-31.91 19.08-32 37.91-0.08 16.84-2.54 32.15 9.47 45.91 13.02 14.93 27.95 13.09 45.53 13.09h91 477c5.08-0.01 10.19-0.33 15-2.13 14.28-5.34 24.82-19.6 25-34.87 0.17-14.95 2.2-30.06-6.6-43-12.41-18.24-28.21-17-47.4-16.91h-90-325-107-55zm672 0.07c-16.9 4.28-30.78 19.01-31 36.84v23c0.27 21.79 19.14 36.97 40 37h142c20.93-0.03 38.74-15.52 39-37 0.08-6.97 0.54-24.06-0.9-30-4.54-18.7-20.23-29.97-39.1-29.84h-98-52zm-607 108.99c-16.74 4.26-30.78 19.22-31 36.85v23c0.27 21.79 19.14 36.97 40 37h323c21.61-0.03 38.89-16.07 39-38v-19c-0.01-5.6-0.15-8.6-2.09-14-4.68-13.04-16.22-23.07-29.91-25.85h-21-29-192-63-34zm415-0.06c-17.73 4.55-30.91 19.41-31 37.91v21c0.27 22.32 18.25 37.97 40 38h57 324c20.85-0.03 38.74-15.59 39-37v-21c-0.04-22.64-17.69-38.97-40-38.91h-56-222-72-39zm-481 109.99c-17.76 4.57-30.78 19.43-31 37.92-0.21 17.76-2.51 35.24 12.09 48.56 11.77 10.74 21.25 10.44 35.91 10.44h21 129 656c5.24-0.01 9.99-0.33 15-2.1 14.29-5.07 24.81-19.78 25-34.9v-23c-0.24-19.97-18.31-36.76-38-36.92h-159-447-145-47-27z"
                        fill="#81c3d7" stroke="none" />
                </svg>
            </li>
            <li class="main-menu-item">
                <svg height="32px" viewBox="0 0 694 725" xmlns="http://www.w3.org/2000/svg">
                    <path class="icon"
                        d="m13 38v646s58 8.28 58 8.28l92 13s56 7.99 56 7.99 30 3.73 30 3.73v-663h57v637h22v-660h-79v-26l-23 2.85-64 9.02-105 14.85s-44 6.28-44 6.28zm466 35-129 129c4.76 6.65 24.92 25.92 32 33l85 85c2.13 2.13 8.46 9.03 11 9.66 3.32 0.83 6.89-3.57 9-5.66l18-18c2.37-2.42 6.04-5.27 4.26-9-0.9-1.87-5.58-6.32-7.26-8l-61-61h240v-45h-246l77-77-16-17-17-16zm-281 256.39c4.92-0.67 9.74-0.81 13.96 2.26 13.5 9.83 4.41 30.58-10.96 28.79-16.99-1.97-19.96-25.58-3-31.05zm362 29.61-32 32 25 26 46 46h-241v45h246l-70 70c-1.63 1.67-4.8 4.51-4.8 7 0 2.96 5.71 7.91 7.8 10l23 23 45-44 85-85-23-24-83-83-24-23z"
                        fill="#81c3d7" stroke="none" />
                </svg>
            </li>
            <li class="main-menu-item">
                <svg height="30px" viewBox="0 0 753 636" xmlns="http://www.w3.org/2000/svg">
                    <path class="icon"
                        d="m357 5.21c-19.66 3.07-36.52 6.32-55 14.22-41.47 17.73-75.64 50.75-92.99 92.57-6.05 14.58-11.82 36.22-12.01 52-0.13 11.67-0.48 23.44 1.27 35 5.34 35.17 21.93 67.56 46.77 92.99 19.03 19.48 45.16 35.08 70.96 43.68 12.83 4.27 33.59 9.17 47 9.33h25c26.83-0.04 59.87-11.19 83-24.43 18.83-10.78 36.97-26.51 50.34-43.57 18.27-23.33 34.31-59.99 34.66-90 0.34-29.22-0.65-48.45-12.43-76-22.04-51.55-69.09-89.22-123.57-101.42-8.55-1.92-22.4-4.48-31-4.37h-32zm-351 623.79h741c-14.1-48.28-32.78-83.9-63.13-124-18.55-24.5-44.28-49.43-68.87-67.87-37.21-27.92-76.56-48.29-121-62.11-28.23-8.77-57.56-14.09-87-16.11l-10-0.91c-30.07-0.35-54.05-0.23-84 4.42-59.69 9.27-117.94 33.33-167 68.49-48.24 34.57-90.7 83.63-116.74 137.09-11.34 23.28-15.44 37.09-23.26 61z"
                        fill="#81c3d7" stroke="none" />
                </svg>
            </li>
            <li class="main-menu-item">
                <svg height="32px" viewBox="0 0 1019 715" xmlns="http://www.w3.org/2000/svg">
                    <path class="icon"
                        d="m82 11v606h-72v33h72v58h32v-58h895v-33h-895v-606h-32zm702 87v482h99v-482h-99zm-302 56v426h99v-426h-99zm-151 112v314h99v-314h-99zm302 40v274h99v-274h-99zm-453 77v197h99v-197h-99z"
                        fill="#81c3d7" stroke="none" />
                </svg>
            </li>
            <li class="main-menu-item">
                <svg height="30px" viewBox=" 0 0 342 613" xmlns="http://www.w3.org/2000/svg">
                    <path class="icon"
                        d="m158 12v28c-27.41 2.17-60.96 11.14-83 27.9-28.54 21.69-48.57 58.91-49 95.1v19c0.03 20.84 8.03 45.69 19.52 63 14.4 21.71 28.81 30.91 51.48 42.25 9.45 4.72 18.97 9.06 29 12.42 9.55 3.19 22.08 7.52 32 8.33v186c-33.88-4.57-60.31-28.27-71.95-60-3.7-10.09-6.46-20.44-8.44-31-0.48-2.55-1.17-10.53-3.2-11.89-2.21-1.48-12.51 1.11-15.41 1.69 0 0-43 8.2-43 8.2 0 36.4 17.44 79.88 44 104.91 20.32 19.14 45.02 28.81 72 34.29 7.94 1.61 18.01 3.73 26 3.8v59h35v-59c39.18-0.86 77.59-17.84 103.83-47 20.46-22.73 34.81-57.23 35.17-88v-19c-0.03-16.54-6.19-40.4-13.89-55-21.92-41.59-56.76-58.44-100.11-69.88l-25-6.12v-168c7.7 1.09 15.07 3.78 22 7.25 28.18 14.09 40.02 39.78 44 69.75 0 0 61-9 61-9-0.03-10.19-2.82-20.36-6-30-9.81-29.67-29.23-55.64-57-70.69-21.96-11.91-39.71-15.11-64-18.31v-28h-35zm0 78v161c-21.37-4.87-48.94-19.33-60.91-38-19.4-30.25-15.02-73.24 10-98.96 12.99-13.36 32.62-21.57 50.91-24.04zm-19 152v1l1-1h-1zm54 252v-177c23.48 5.36 56.82 21.39 68.69 43 5.67 10.33 9.17 24.22 9.31 36 0.16 13.96-0.34 26.64-5.09 40-11.04 31.06-39.59 55.28-72.91 58zm-37-2v1l1-1h-1z"
                        fill="#81c3d7" stroke="none" />
                </svg>
            </li>
        </ul>
    </nav>
    <main>
        <div class="toolset">
            <div class="btn-group">
                <a class="btn" href="#">Heute</a>
            </div>
            <div class="btn-group">
                <a class="btn" href="#">Jan</a>
                <a class="btn" href="#">Feb</a>
                <a class="btn" href="#">Mar</a>
            </div>
            <div class="btn-group">
                <a class="btn" href="#">Apr</a>
                <a class="btn" href="#">Mai</a>
                <a class="btn" href="#">Jun</a>
            </div>
            <div class="btn-group">
                <a class="btn" href="#">Jul</a>
                <a class="btn" href="#">Aug</a>
                <a class="btn" href="#">Sep</a>
            </div>
            <div class="btn-group">
                <a class="btn" href="#">Okt</a>
                <a class="btn" href="#">Nov</a>
                <a class="btn" href="#">Dez</a>
            </div>
            <div class="btn-group">
                <a class="btn" href="#">2019</a>
                <a class="btn" href="#">2020</a>
                <a class="btn" href="#">2021</a>
            </div>
            <div class="btn-group">
                <a class="btn" href="#">CAL</a>
            </div>
            <div class="btn-group">
                <a class="btn" href="#">14 d</a>
                <a class="btn" href="#">30 d</a>
                <a class="btn" href="#">60 d</a>
            </div>
            <div class="btn-group">
                <a class="btn" href="#">slim</a>
                <a class="btn" href="#">full</a>
            </div>
        </div>
        <p id="result">None</p>
        <canvas id="myCanvas" style="border:none #d3d3d3;"></canvas>
    </main>
</body>

<script>
    // draft project class
    class Project {
        constructor(proj_nr, amp_i, start, stop, status) {
            this.proj_nr = proj_nr;
            this.amp_i = amp_i;
            this.start = start;
            this.stop = stop;
            this.status = status;
        }
    }

    // dummy test data
    var pro1 = new Project(20200021, "Stefano", "16.04.2020", "20.04.2020", "open");
    var pro2 = new Project(20200230, "Michel", "13.05.2020", "19.05.2020", "open");
    var pro3 = new Project(20200236, "Rafi", "24.04.2020", "09.05.2020", "open");
    var pros = [pro1, pro2, pro3];

    // test data access
    /*
    for (p in pros) {
        console.log(pros[p].amp_i);
    }
    */

    // prep date
    // extend class with diff nr of days
    Date.prototype.addDays = function (days) {
        var date = new Date(this.valueOf());
        date.setDate(date.getDate() + days);
        return date;
    }
    var date = new Date();
    // func to get standard format for date
    function formatDate(date) {
        // get month and day number of "date" (date is of Class Date and has no specific format)
        var month = date.getMonth() + 1, day = date.getDate();
        // if month is single digit add "0" at beginning so that all dates have same length
        var month_str = (month > 9) ? month.toString() : "0" + month.toString();
        // if day is single digit add "0" at beginning so that all dates have same length
        var day_str = (day > 9) ? day.toString() : "0" + day.toString();
        return day_str + "." + month_str;
    }


    // extend canvas context to draw rounded rectangles
    CanvasRenderingContext2D.prototype.roundedRect = function (x, y, width, height, radius) {
        // Because the function is added to the context prototype
        // the 'this' variable is actually the context

        // Save the existing state of the canvas so that it can be restored later
        this.save();

        // Translate to the given X/Y coordinates
        this.translate(x, y);

        // Move to the center of the top horizontal line
        this.moveTo(width / 2, 0);

        // Draw the rounded corners. The connecting lines in between them are drawn automatically
        this.arcTo(width, 0, width, height, Math.min(height / 2, radius));
        this.arcTo(width, height, 0, height, Math.min(width / 2, radius));
        this.arcTo(0, height, 0, 0, Math.min(height / 2, radius));
        this.arcTo(0, 0, radius, 0, Math.min(width / 2, radius));

        // Draw a line back to the start coordinates
        this.lineTo(width / 2, 0);

        // Restore the state of the canvas to as it was before the save
        this.restore();
    }

    // start canvas handling
    // get canvas objects
    var c = document.getElementById("myCanvas");
    var ctx = c.getContext("2d");

    // size and split params have to be knwon outside as well for data drawing
    var v_split_center;
    var nr_v_splits;
    var delta_v;
    var nr_h_splits;
    var delta_h;
    var header_padding_size = 20;
    var header_keys = [];
    var header_dates = [];
    // edges of header range to compare to
    var low_border;
    var high_border;

    // get today to compare with dates that are written on top
    // later: if column = today, shade it
    var today = new Date();
    var today_str = formatDate(today);

    // draw pare canvas
    function drawCanvas() {
        c.width = window.innerWidth * 0.9;
        c.height = window.innerHeight * 0.9;
        // params for vertical line
        nr_v_splits = 30;
        v_split_center = nr_v_splits / 2;
        delta_v = c.width / nr_v_splits;
        // change ctx settings for vertical lines
        ctx.font = "10px Verdana";
        ctx.strokeStyle = "#2E8986";
        // ctx.setLineDash([10, 3]);
        ctx.lineWidth = 1;
        header_keys = [];
        header_dates = [];

        // draw vertical lines
        for (var d = 0; d <= nr_v_splits; d++) {
            ctx.beginPath();
            // define current text label
            const c_date = date.addDays(d - v_split_center);
            let label = formatDate(c_date);
            header_keys.push(label);
            header_dates.push(c_date);
            // write date: start from currently set 'center date' "var date", add or remove #days from there
            ctx.fillStyle = "#f2f2f2";
            ctx.fillText(label, (d - 0.85) * delta_v, 16);
            ctx.moveTo(d * delta_v, header_padding_size);
            ctx.lineTo(d * delta_v, c.height);
            ctx.stroke();
            // if column = today, shade it
            // get date in same format of currently written date
            var cur_date = date.addDays(d - v_split_center);
            var cur_date_str = formatDate(cur_date);
            var cur_date_day = cur_date.getDay();
            var isWeekend = (cur_date_day === 6) || (cur_date_day === 0);

            // if currently written date is a weekend or euals today -> shade it!
            if (today_str == cur_date_str || isWeekend) {
                // set shade color
                ctx.fillStyle = "#226260";
                // draw rect: params: (start hor, start vert, width, height)
                ctx.fillRect((d - 1) * delta_v + 2, header_padding_size, delta_v - 4, c.height);
                // reset color for following dates to right (fillText)
                ctx.fillStyle = "#f2f2f2";
                // if currently written date equals today -> shade boarders as well!
                if (today_str == cur_date_str) {
                    ctx.strokeStyle = "#f2f2f2";
                    ctx.moveTo((d - 1) * delta_v, header_padding_size);
                    ctx.lineTo((d - 1) * delta_v, c.height);
                    ctx.stroke();
                    ctx.moveTo(d * delta_v, header_padding_size);
                    ctx.lineTo(d * delta_v, c.height);
                    ctx.stroke();
                    ctx.strokeStyle = "#2E8986";
                }
            }
        }

        // get edges to compare
        low_border = header_keys[0];
        high_border = header_keys[header_keys.length - 1];
        // params for horizontal lines
        nr_h_splits = 22; // eg nr of apm-i, nr of projcets
        delta_h = (c.height - header_padding_size) / nr_h_splits;
        ctx.strokeStyle = "#2E8986";
        ctx.lineWidth = 1;
        ctx.setLineDash([1, 0]);

        // draw horizontal lines
        for (var d = 1; d <= nr_h_splits; d++) {
            ctx.beginPath();
            // ctx.fillText(formatDate(date.addDays(d - v_split_center)), (d - 0.85) * delta_v, 16);
            ctx.moveTo(0, header_padding_size + d * delta_h);
            ctx.lineTo(c.width, header_padding_size + d * delta_h);
            ctx.stroke();
        }

        // now call data drawing function (updateded values of start date etc)
        // drawDataOfCurrentRange();
        drawRectWithWrapper("08.05.2020", "30.05.2020", 1, "#2E8986");
        drawRectWithWrapper("12.05.2020", "22.05.2020", 2, "#2E8986");
        drawRectWithWrapper("17.04.2020", "02.05.2020", 3, "#2E8986");
        drawRectWithWrapper("05.05.2020", "12.05.2020", 4, "#2E8986");
        drawRectWithWrapper("01.05.2020", "06.05.2020", 5, "#2E8986");
        /*
        // Todo: handle fanishing of worm and overfloting on boardre (not done yet)
        */
    }

    function drawRectWithWrapper(start_date, end_date, row, color) {
        // first task: get from date formats which were provided to comparable date
        // split date string to get individual numbers of day, month, year (in array)
        const s_date_temp = start_date.split(".");
        const e_date_temp = end_date.split(".");
        // create new date out of numbers: new Date(year, month, day). Month goes from 0-11 in constructor --> -1.
        const s_date = new Date(s_date_temp[2], s_date_temp[1] - 1, s_date_temp[0]);
        const e_date = new Date(e_date_temp[2], e_date_temp[1] - 1, e_date_temp[0]);
        // change Date type into format used as header keys
        const start_key = formatDate(s_date);
        const end_key = formatDate(e_date);
        // get index of start_key in header list. This will be multiplied by vertical line spacing
        let sta_col = header_keys.indexOf(start_key);
        // get index of end_key in header list. This will be multiplied by horizontal line spacing
        let end_col = header_keys.indexOf(end_key);
        /*
        // IDEA OF WHAT FOLLOWS
        // indexOf retunrs -1 if element is not found.
        // the key is then out of bounds on EITHER side of the displayed range
        // there are 5 cases:
        //      1) both keys (col) are within bounds -> no problem, draw rectangle
        //      2) sta_col is out of bounds, end_col is within bounds -> rect overflows on LEFT boarder
        //      3) sta_col is within bounds, end_col is out of bounds -> rect overflows on RIGHT boarder
        //      4.1) both keys (cols) are out of bounds on OPPOSIT sides -> rect spans whole row
        //      4.2) both keys (cols) are out of bounds on SAME sides -> no rectangle to be drawn
        */
        // define consts that are the same for all cases
        const start_y = header_padding_size + row * delta_h + delta_h * 0.1; // start y (vertical axis)
        const v_strech = delta_h * 0.8; // vertical strech (height)
        const radius = 12;
        let start_x;
        let h_strech;
        // CASE 1: both are in
        if (sta_col > -1 && end_col > -1) {
            start_x = (sta_col) * delta_v - delta_v * 0.5; // start x (horizontal axis)
            h_strech = delta_v * (end_col - sta_col); // horizontal stretch (length)
        };
        // CASE 2: start is out, end is in
        if (sta_col < 0 && end_col > -1) {
            start_x = - delta_h * 0.5; // start x (horizontal axis)
            h_strech = delta_v * (end_col); // horizontal stretch (length)
        }
        // CASE 3: start is in, end is out
        if (sta_col > -1 && end_col < 0) {
            start_x = (sta_col) * delta_v - delta_v * 0.5; // start x (horizontal axis)
            h_strech = delta_v * (nr_v_splits + 1 - sta_col); // horizontal stretch (length)
        }
        // CASE 4.1 and 4.2
        if (sta_col < 0 && end_col < 0) {
            // 4.1 both on opposite sides...
            // this is the case if start is lower then lower bound and end date higher than upper bound
            if (s_date.getTime() < header_dates[0].getTime() && e_date.getTime() > header_dates[header_dates.length - 1].getTime()) {
                start_x = - delta_h * 0.5; // start x (horizontal axis)
                h_strech = c.width + delta_h; // horizontal stretch (length)
            } else {
                // 4.2 both are out on the same side --> draw nothing
                return;
            }
        }
        drawSingleRect(start_x, start_y, h_strech, v_strech, radius, color);
    };

    function drawSingleRect(start_x, start_y, length_x, height_y, border_radius, color) {
        ctx.beginPath();
        ctx.fillStyle = color;
        ctx.roundedRect(start_x, start_y, length_x, height_y, border_radius);
        ctx.stroke();
        ctx.fill();
    }

    // scroll left rigth with arrow keys
    document.onkeydown = function (e) {
        if (e.keyCode == 37) date = date.addDays(-1);
        if (e.keyCode == 39) date = date.addDays(1);
        drawCanvas();
    }

    // redraw canvas when window is resized
    window.onresize = drawCanvas;
    // draw canvas on document load, b/c just calling on resize won't draw it on first load
    window.onload = drawCanvas;

    c.onmousemove = function (e) {
        var rect = c.getBoundingClientRect();
        var par = document.getElementById("result")
        par.innerHTML = e.clientX - rect.left;
    }

</script>

</html>